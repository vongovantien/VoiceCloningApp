<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ƒêƒÉng nh·∫≠p - Story Telling App</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
    <script src="{{ url_for('static', filename='js/theme.js') }}"></script>
    <style>
        .auth-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
        }

        .auth-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 40px;
            max-width: 450px;
            width: 100%;
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .auth-tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            color: rgba(255, 255, 255, 0.5);
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 2px solid transparent;
        }

        .auth-tab.active {
            color: #ffd700;
            border-bottom-color: #ffd700;
        }

        .auth-tab:hover {
            color: rgba(255, 255, 255, 0.8);
        }

        .form-floating {
            margin-bottom: 20px;
        }

        .form-floating input {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            border-radius: 10px;
        }

        .form-floating input:focus {
            background: rgba(255, 255, 255, 0.1);
            border-color: #ffd700;
            box-shadow: 0 0 0 0.2rem rgba(255, 215, 0, 0.25);
            color: white;
        }

        .form-floating label {
            color: rgba(255, 255, 255, 0.5);
        }

        .btn-auth {
            background: linear-gradient(135deg, #ffd700 0%, #ff8c00 100%);
            border: none;
            padding: 12px;
            border-radius: 10px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-auth:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(255, 215, 0, 0.3);
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .alert {
            border-radius: 10px;
        }

        .logo-text {
            color: #ffd700;
            font-size: 2rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 10px;
        }

        .logo-text i {
            margin-right: 10px;
        }

        .subtitle {
            color: rgba(255, 255, 255, 0.6);
            text-align: center;
            margin-bottom: 30px;
        }

        .form-check-input:checked {
            background-color: #ffd700;
            border-color: #ffd700;
        }

        .forgot-link {
            color: #ffd700;
            text-decoration: none;
        }

        .forgot-link:hover {
            text-decoration: underline;
        }

        .back-home {
            position: fixed;
            top: 20px;
            left: 20px;
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
        }

        .back-home:hover {
            color: #ffd700;
        }
    </style>
</head>

<body>
    <a href="/" class="back-home">
        <i class="fas fa-arrow-left me-2"></i>Trang ch·ªß
    </a>
    <button id="themeToggle" class="theme-toggle" style="position: fixed; top: 20px; right: 20px;"
        title="Chuy·ªÉn ƒë·ªïi theme">
        <i class="fas fa-sun"></i>
    </button>

    <div class="auth-container">
        <div class="auth-card">
            <div class="logo-text">
                <i class="fas fa-book-open"></i>Story Telling
            </div>
            <p class="subtitle">K·ªÉ chuy·ªán b·∫±ng gi·ªçng n√≥i AI</p>

            <!-- Alert message -->
            <div id="alertMessage" class="alert d-none" role="alert"></div>

            <!-- Tabs -->
            <div class="auth-tabs">
                <div class="auth-tab active" data-tab="login">
                    <i class="fas fa-sign-in-alt me-2"></i>ƒêƒÉng nh·∫≠p
                </div>
                <div class="auth-tab" data-tab="register">
                    <i class="fas fa-user-plus me-2"></i>ƒêƒÉng k√Ω
                </div>
            </div>

            <!-- Login Form -->
            <form id="loginForm" class="auth-form active">
                <div class="form-floating">
                    <input type="email" class="form-control" id="loginEmail" placeholder="Email" required>
                    <label for="loginEmail"><i class="fas fa-envelope me-2"></i>Email</label>
                </div>
                <div class="form-floating">
                    <input type="password" class="form-control" id="loginPassword" placeholder="M·∫≠t kh·∫©u" required>
                    <label for="loginPassword"><i class="fas fa-lock me-2"></i>M·∫≠t kh·∫©u</label>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="rememberMe">
                        <label class="form-check-label text-white-50" for="rememberMe">Ghi nh·ªõ</label>
                    </div>
                    <a href="#" class="forgot-link" id="forgotPasswordLink">Qu√™n m·∫≠t kh·∫©u?</a>
                </div>
                <button type="submit" class="btn btn-auth w-100">
                    <i class="fas fa-sign-in-alt me-2"></i>ƒêƒÉng nh·∫≠p
                </button>
            </form>

            <!-- Register Form -->
            <form id="registerForm" class="auth-form">
                <div class="form-floating">
                    <input type="text" class="form-control" id="regUsername" placeholder="T√™n ng∆∞·ªùi d√πng" required
                        minlength="3">
                    <label for="regUsername"><i class="fas fa-user me-2"></i>T√™n ng∆∞·ªùi d√πng</label>
                </div>
                <div class="form-floating">
                    <input type="email" class="form-control" id="regEmail" placeholder="Email" required>
                    <label for="regEmail"><i class="fas fa-envelope me-2"></i>Email</label>
                </div>
                <div class="form-floating">
                    <input type="password" class="form-control" id="regPassword" placeholder="M·∫≠t kh·∫©u" required
                        minlength="6">
                    <label for="regPassword"><i class="fas fa-lock me-2"></i>M·∫≠t kh·∫©u (√≠t nh·∫•t 6 k√Ω t·ª±)</label>
                </div>
                <div class="row mb-3">
                    <div class="col-6">
                        <div class="form-floating">
                            <input type="number" class="form-control" id="regAge" placeholder="Tu·ªïi" min="1" max="100">
                            <label for="regAge"><i class="fas fa-birthday-cake me-2"></i>Tu·ªïi</label>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="form-floating">
                            <select class="form-select" id="regCountry">
                                <option value="VN">üáªüá≥ Vi·ªát Nam</option>
                                <option value="FOREIGN">üåç N∆∞·ªõc ngo√†i</option>
                            </select>
                            <label for="regCountry">Qu·ªëc gia</label>
                        </div>
                    </div>
                </div>
                <!-- Role Selection -->
                <div class="mb-3">
                    <label class="form-label text-white-50 mb-2"><i class="fas fa-user-tag me-2"></i>Vai tr√≤</label>
                    <select class="form-select" id="regRole"
                        style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white;">
                        <!-- Roles will be loaded dynamically -->
                    </select>
                </div>
                <button type="submit" class="btn btn-auth w-100">
                    <i class="fas fa-user-plus me-2"></i>ƒêƒÉng k√Ω
                </button>
            </form>

            <!-- Forgot Password Form -->
            <form id="forgotForm" class="auth-form">
                <p class="text-white-50 mb-4">
                    Nh·∫≠p email c·ªßa b·∫°n ƒë·ªÉ nh·∫≠n link ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u.
                </p>
                <div class="form-floating">
                    <input type="email" class="form-control" id="forgotEmail" placeholder="Email" required>
                    <label for="forgotEmail"><i class="fas fa-envelope me-2"></i>Email</label>
                </div>
                <button type="submit" class="btn btn-auth w-100 mb-3">
                    <i class="fas fa-paper-plane me-2"></i>G·ª≠i link
                </button>
                <a href="#" class="text-center d-block text-white-50" id="backToLogin">
                    <i class="fas fa-arrow-left me-2"></i>Quay l·∫°i ƒëƒÉng nh·∫≠p
                </a>
            </form>
        </div>
    </div>

    <script>
        // Tab switching
        document.querySelectorAll('.auth-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));

                tab.classList.add('active');
                const targetForm = tab.dataset.tab + 'Form';
                document.getElementById(targetForm).classList.add('active');
                hideAlert();
            });
        });

        // Forgot password link
        document.getElementById('forgotPasswordLink').addEventListener('click', (e) => {
            e.preventDefault();
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
            document.getElementById('forgotForm').classList.add('active');
        });

        // Back to login
        document.getElementById('backToLogin').addEventListener('click', (e) => {
            e.preventDefault();
            document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
            document.getElementById('loginForm').classList.add('active');
            document.querySelector('[data-tab="login"]').classList.add('active');
        });

        function showAlert(message, type = 'danger') {
            const alert = document.getElementById('alertMessage');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alert.classList.remove('d-none');
        }

        function hideAlert() {
            document.getElementById('alertMessage').classList.add('d-none');
        }

        // Login form
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const res = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const data = await res.json();

                if (res.ok) {
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('user', JSON.stringify(data.user));
                    showAlert('ƒêƒÉng nh·∫≠p th√†nh c√¥ng! ƒêang chuy·ªÉn h∆∞·ªõng...', 'success');
                    setTimeout(() => {
                        window.location.href = data.user.is_admin ? '/admin' : '/';
                    }, 1000);
                } else {
                    showAlert(data.error);
                }
            } catch (err) {
                showAlert('ƒê√£ x·∫£y ra l·ªói. Vui l√≤ng th·ª≠ l·∫°i.');
            }
        });

        // Register form
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('regUsername').value;
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;
            const age = document.getElementById('regAge').value || null;
            const country = document.getElementById('regCountry').value;
            const role_id = document.getElementById('regRole').value || null;

            try {
                const res = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username,
                        email,
                        password,
                        age: age ? parseInt(age) : null,
                        country,
                        role_id: role_id ? parseInt(role_id) : null
                    })
                });
                const data = await res.json();

                if (res.ok) {
                    showAlert('ƒêƒÉng k√Ω th√†nh c√¥ng! Vui l√≤ng ki·ªÉm tra email ƒë·ªÉ x√°c th·ª±c.', 'success');
                    // Switch to login tab
                    setTimeout(() => {
                        document.querySelector('[data-tab="login"]').click();
                    }, 2000);
                } else {
                    showAlert(data.error);
                }
            } catch (err) {
                showAlert('ƒê√£ x·∫£y ra l·ªói. Vui l√≤ng th·ª≠ l·∫°i.');
            }
        });

        // Forgot password form
        document.getElementById('forgotForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('forgotEmail').value;

            try {
                const res = await fetch('/api/auth/forgot-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });
                const data = await res.json();

                if (res.ok) {
                    showAlert(data.message, 'success');
                } else {
                    showAlert(data.error);
                }
            } catch (err) {
                showAlert('ƒê√£ x·∫£y ra l·ªói. Vui l√≤ng th·ª≠ l·∫°i.');
            }
        });

        // Load roles for registration
        async function loadRoles() {
            try {
                const res = await fetch('/api/auth/roles');
                const data = await res.json();

                if (data.status === 'ok') {
                    const select = document.getElementById('regRole');
                    select.innerHTML = data.roles.map(role =>
                        `<option value="${role.role_id}">${role.name}</option>`
                    ).join('');
                }
            } catch (err) {
                console.error('Error loading roles:', err);
            }
        }

        // Check for verified query param
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('verified') === '1') {
            showAlert('Email ƒë√£ ƒë∆∞·ª£c x√°c th·ª±c! B·∫°n c√≥ th·ªÉ ƒëƒÉng nh·∫≠p.', 'success');
        }

        // Load roles on page load
        loadRoles();
    </script>
</body>

</html>